# OpenCode é˜¿é‡Œäº‘ä¸€é”®éƒ¨ç½²è®¾è®¡æ–‡æ¡£

## ç›®å½•

- [1. èƒŒæ™¯ä¸ç›®æ ‡](#1-èƒŒæ™¯ä¸ç›®æ ‡)
  - [1.1 é—®é¢˜](#11-é—®é¢˜)
  - [1.2 å¯å‘](#12-å¯å‘)
  - [1.3 ç›®æ ‡](#13-ç›®æ ‡)
  - [1.4 éç›®æ ‡](#14-éç›®æ ‡)
- [2. æ€»ä½“è®¾è®¡](#2-æ€»ä½“è®¾è®¡)
- [3. è®¾è®¡å†³ç­–](#3-è®¾è®¡å†³ç­–)
  - [3.1 äº‘æœåŠ¡é€‰å‹ï¼šä¸ºä»€ä¹ˆé€‰ ECS è€Œé SAE](#31-äº‘æœåŠ¡é€‰å‹ä¸ºä»€ä¹ˆé€‰-ecs-è€Œé-sae)
  - [3.2 è®¤è¯æ–¹æ¡ˆï¼šä¸ºä»€ä¹ˆé€‰ Authelia](#32-è®¤è¯æ–¹æ¡ˆä¸ºä»€ä¹ˆé€‰-authelia)
  - [3.3 åå‘ä»£ç†ï¼šä¸ºä»€ä¹ˆé€‰ Caddy è€Œé Nginx](#33-åå‘ä»£ç†ä¸ºä»€ä¹ˆé€‰-caddy-è€Œé-nginx)
  - [3.4 è®¤è¯æ–¹å¼ï¼šä¸ºä»€ä¹ˆé€‰ä¸¤æ­¥è®¤è¯è€Œé Basic Auth](#34-è®¤è¯æ–¹å¼ä¸ºä»€ä¹ˆé€‰ä¸¤æ­¥è®¤è¯è€Œé-basic-auth)
- [4. æ¶æ„è®¾è®¡](#4-æ¶æ„è®¾è®¡)
  - [4.1 æ ¸å¿ƒåˆ†å±‚](#41-æ ¸å¿ƒåˆ†å±‚)
  - [4.2 ç½‘ç»œæ¶æ„](#42-ç½‘ç»œæ¶æ„)
  - [4.3 å®‰å…¨æ¶æ„](#43-å®‰å…¨æ¶æ„)
- [5. ç»„ä»¶è®¾è®¡](#5-ç»„ä»¶è®¾è®¡)
  - [5.1 Deploy Scriptï¼ˆéƒ¨ç½²è„šæœ¬ï¼‰](#51-deploy-scriptéƒ¨ç½²è„šæœ¬)
  - [5.2 Docker Composeï¼ˆå®¹å™¨ç¼–æ’ï¼‰](#52-docker-composeå®¹å™¨ç¼–æ’)
  - [5.3 Caddyï¼ˆåå‘ä»£ç† + HTTPSï¼‰](#53-caddyåå‘ä»£ç†--https)
  - [5.4 ç¯å¢ƒå˜é‡](#54-ç¯å¢ƒå˜é‡)
  - [5.5 Autheliaï¼ˆè®¤è¯ç½‘å…³ï¼‰](#55-autheliaè®¤è¯ç½‘å…³)
  - [5.6 OpenCodeï¼ˆAI ç¼–ç¨‹åŠ©æ‰‹ï¼‰](#56-opencodeai-ç¼–ç¨‹åŠ©æ‰‹)
- [6. ç”¨æˆ·ä½“éªŒæµç¨‹](#6-ç”¨æˆ·ä½“éªŒæµç¨‹)
  - [6.1 éƒ¨ç½²æµç¨‹](#61-éƒ¨ç½²æµç¨‹)
  - [6.2 é¦–æ¬¡ç™»å½•ï¼ˆæ³¨å†Œ Passkeyï¼‰](#62-é¦–æ¬¡ç™»å½•æ³¨å†Œ-passkey)
  - [6.3 æ—¥å¸¸ä½¿ç”¨](#63-æ—¥å¸¸ä½¿ç”¨)
- [7. æˆæœ¬ä¼°ç®—](#7-æˆæœ¬ä¼°ç®—)
- [8. å®ç°è§„åˆ’](#8-å®ç°è§„åˆ’)
  - [8.1 ç›®å½•ç»“æ„](#81-ç›®å½•ç»“æ„)
  - [8.2 å®ç°æ­¥éª¤](#82-å®ç°æ­¥éª¤)
  - [8.3 æµ‹è¯•è¦ç‚¹](#83-æµ‹è¯•è¦ç‚¹)
- [9. è¿ç»´ä¸å¤‡ä»½](#9-è¿ç»´ä¸å¤‡ä»½)
- [å‚è€ƒæ–‡çŒ®](#å‚è€ƒæ–‡çŒ®)

---

## 1. èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 é—®é¢˜

åœ¨æ‰‹æœºæˆ–å…¶ä»–ç§»åŠ¨è®¾å¤‡ä¸Šä½¿ç”¨ OpenCode Web UI æ—¶ï¼Œé¢ä¸´ä»¥ä¸‹å®‰å…¨é£é™©ï¼š

| é£é™© | è¯´æ˜ |
|------|------|
| **HTTP æ˜æ–‡ä¼ è¾“** | Basic Auth å¯†ç ã€API Key é€šè¿‡ HTTP ä¼ è¾“ï¼Œæ˜“è¢«ä¸­é—´äººæ”»å‡»æˆªè· |
| **VM ç«¯å£æš´éœ²** | SSH (22)ã€OpenCode (4096) ç«¯å£å¯¹å…¬ç½‘å¼€æ”¾ï¼Œå¢åŠ æ”»å‡»é¢ |
| **ç¼ºä¹å¼ºè®¤è¯** | Basic Auth ä»…ä¸€å±‚å¯†ç ä¿æŠ¤ï¼Œæ—  2FA ç­‰å¼ºè®¤è¯æœºåˆ¶ |
| **æ—  HTTPS** | æµè§ˆå™¨å®‰å…¨è­¦å‘Šï¼Œç§»åŠ¨ç«¯ä½“éªŒå·® |

### 1.2 å¯å‘

[opencode-cloud](https://github.com/pRizz/opencode-cloud) é¡¹ç›®æä¾›äº†ä¼˜ç§€çš„å®è·µï¼š

- **ä¸¤æ­¥è®¤è¯**ï¼šWebAuthn/FIDO2 ä½œä¸ºç¬¬äºŒå› ç´ ï¼Œæ‰‹æœºåŸç”Ÿæ”¯æŒ
- **Docker sandbox**ï¼šå®¹å™¨éš”ç¦»ï¼Œä¸æ±¡æŸ“å®¿ä¸»æœº
- **ä¸€é”®éƒ¨ç½²è„šæœ¬**ï¼šè‡ªåŠ¨åŒ–èµ„æºåˆ›å»ºå’Œé…ç½®

å…¶å±€é™ï¼š

- ä»…æ”¯æŒ AWS/Railway/DigitalOceanï¼Œä¸æ”¯æŒé˜¿é‡Œäº‘
- ä¾èµ– fork ç‰ˆæœ¬ opencodeï¼Œå¯èƒ½ä¸ upstream æœ‰å·®è·

### 1.3 ç›®æ ‡

æ„å»ºä¸€ä¸ªä¸€é”®å¼éƒ¨ç½²å·¥å…· **cloudcode**ï¼Œå°† OpenCode éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æµ·å¤–åœ°åŸŸï¼š

- **å®‰å…¨è®¿é—®**ï¼šHTTPS + ä¸¤æ­¥è®¤è¯ï¼ˆå¯†ç  + Passkeyï¼‰ï¼Œæœç»æ˜æ–‡ä¼ è¾“
- **ç«¯å£éš”ç¦»**ï¼šOpenCode å®¹å™¨ä¸ç›´æ¥æš´éœ²ï¼Œé€šè¿‡åå‘ä»£ç†è®¿é—®
- **ä¸€é”®éƒ¨ç½²**ï¼šè‡ªåŠ¨åŒ–åˆ›å»º ECSã€é…ç½® Dockerã€éƒ¨ç½²åº”ç”¨
- **ä½æˆæœ¬**ï¼šæœˆè´¹ç”¨æ§åˆ¶åœ¨ $30 ä»¥å†…

### 1.4 éç›®æ ‡

- **ä¸åšå¤šç”¨æˆ·**ï¼šå•ä¿¡ä»»åŸŸï¼Œä»…æ”¯æŒå•ä¸€ç”¨æˆ·
- **ä¸åšé«˜å¯ç”¨**ï¼šå•å®ä¾‹éƒ¨ç½²ï¼Œæ— è´Ÿè½½å‡è¡¡
- **ä¸åšå®šæ—¶å¯åœ**ï¼š24/7 è¿è¡Œï¼Œä¸èŠ‚çœé—²æ—¶æˆæœ¬
- **ä¸åšå¤šåœ°åŸŸ**ï¼šå›ºå®šæ–°åŠ å¡åœ°åŸŸ
- **ä¸åšç”Ÿäº§çº§ç›‘æ§**ï¼šåŸºç¡€æ—¥å¿—æ”¶é›†å³å¯

---

## 2. æ€»ä½“è®¾è®¡

æ ¸å¿ƒæ€è·¯ï¼š**å•æœº ECS + Docker Compose + Authelia ä¸¤æ­¥è®¤è¯ï¼ˆå¯†ç  + Passkeyï¼‰**ã€‚

```
+----------------------------------------------------------------------+
|                              ç”¨æˆ·æµè§ˆå™¨                               |
|                           (HTTPS Only)                               |
+---------------------------------+------------------------------------+
                                  |
                                  v
+----------------------------------------------------------------------+
|                          é˜¿é‡Œäº‘ ECS (æ–°åŠ å¡)                          |
|                        Ubuntu 24.04 (2C4G, 24/7)                     |
|  +----------------------------------------------------------------+  |
|  |                      Docker Compose                            |  |
|  |                                                                |  |
|  |  +----------------+     +------------------+                   |  |
|  |  |     Caddy      |     |     Authelia     |                   |  |
|  |  |  (Reverse      |---->|   (Auth Gateway) |                   |  |
|  |  |   Proxy)       |     |   â€¢ 1FA: å¯†ç     |                   |  |
|  |  |  â€¢ Auto HTTPS  |     |   â€¢ 2FA: Passkey |                   |  |
|  |  |  â€¢ Port: 80/443|     |   â€¢ Port: 9091   |                   |  |
|  |  +-------+--------+     +--------+---------+                   |  |
|  |          |                       |                              |  |
|  |          |  Authenticated        |                              |  |
|  |          v                       v                              |  |
|  |  +----------------------------------------------------------------+  |
|  |  |                    OpenCode Container                          |  |
|  |  |  â€¢ Port: 4096 (localhost only)                                 |  |
|  |  |  â€¢ Workspace: Docker Volume                                    |  |
|  |  +----------------------------------------------------------------+  |
|  |                                                                |  |
|  |  +------------------------------------------------------------+  |  |
|  |  |                    Docker Volumes                           |  |  |
|  |  |  â€¢ opencode-workspace (å·¥ä½œåŒºæŒä¹…åŒ–)                         |  |  |
|  |  |  â€¢ caddy_data (SSL è¯ä¹¦)                                    |  |  |
|  |  |  é…ç½®æ–‡ä»¶ (bind mount):                                      |  |  |
|  |  |  â€¢ ./authelia (Authelia é…ç½®åŠè¿è¡Œæ—¶æ•°æ®)                    |  |  |
|  |  +------------------------------------------------------------+  |  |
|  +----------------------------------------------------------------+  |
+----------------------------------------------------------------------+
                                  |
                                  v
                        +------------------+
                        |   EIP (å…¬ç½‘ IP)   |
                        |   Access via     |
                        |   HTTPS          |
                        +------------------+
```

å…³é”®è®¾è®¡å†³ç­–ï¼š

| å†³ç­– | é€‰æ‹© | æ ¸å¿ƒç†ç”± | è¯¦è§ |
|------|------|----------|------|
| äº‘æœåŠ¡ | ECSï¼ˆé SAEï¼‰ | æˆæœ¬ä½ 5 å€ | [3.1](#31-äº‘æœåŠ¡é€‰å‹ä¸ºä»€ä¹ˆé€‰-ecs-è€Œé-sae) |
| è®¤è¯ç»„ä»¶ | Authelia | è½»é‡ã€Passkey åŸç”Ÿæ”¯æŒ | [3.2](#32-è®¤è¯æ–¹æ¡ˆä¸ºä»€ä¹ˆé€‰-authelia) |
| åå‘ä»£ç† | Caddy | è‡ªåŠ¨ HTTPSï¼Œé…ç½®ç®€å• | [3.3](#33-åå‘ä»£ç†ä¸ºä»€ä¹ˆé€‰-caddy-è€Œé-nginx) |
| è®¤è¯æ–¹å¼ | ä¸¤æ­¥è®¤è¯ï¼ˆå¯†ç  + Passkeyï¼‰ | æ¯” Basic Auth æ›´å®‰å…¨ | [3.4](#34-è®¤è¯æ–¹å¼ä¸ºä»€ä¹ˆé€‰ä¸¤æ­¥è®¤è¯è€Œé-basic-auth) |

---

## 3. è®¾è®¡å†³ç­–

### 3.1 äº‘æœåŠ¡é€‰å‹ï¼šä¸ºä»€ä¹ˆé€‰ ECS è€Œé SAE

| ç»´åº¦ | ECS | SAE |
|------|-----|-----|
| æœˆè´¹ç”¨ (2C4G 24/7) | ~$20 | ~$110 |
| HTTPS é…ç½® | éœ€è‡ªè¡Œé…ç½® Caddy | è‡ªåŠ¨ HTTPS |
| è¿ç»´å¤æ‚åº¦ | ä¸­ï¼ˆéœ€ç®¡ç† VMï¼‰ | ä½ï¼ˆæ‰˜ç®¡æœåŠ¡ï¼‰ |
| æŒä¹…åŒ–å­˜å‚¨ | Docker Volumeï¼ˆç®€å•ï¼‰ | NASï¼ˆéœ€é…ç½®ï¼‰ |
| å†·å¯åŠ¨ | æ—  | ~30s |

**å†³ç­–**ï¼šé€‰æ‹© ECSã€‚

**ç†ç”±**ï¼š
1. æˆæœ¬ä¼˜åŠ¿æ˜æ˜¾ï¼ˆ$20 vs $110ï¼‰
2. å•æœºéƒ¨ç½²ï¼Œè¿ç»´å¤æ‚åº¦å¯æ¥å—
3. æ›´çµæ´»ï¼Œå¯è‡ªè¡Œå®šåˆ¶ç¯å¢ƒ

**ä»£ä»·**ï¼š
1. éœ€è¦æ‰‹åŠ¨é…ç½® HTTPSï¼ˆä½† Caddy è‡ªåŠ¨åŒ–ç¨‹åº¦é«˜ï¼‰
2. éœ€è¦ 5-10 åˆ†é’Ÿåˆå§‹éƒ¨ç½²æ—¶é—´

### 3.2 è®¤è¯æ–¹æ¡ˆï¼šä¸ºä»€ä¹ˆé€‰ Authelia

| ç»´åº¦ | Authelia | Authentik | OAuth2 Proxy |
|------|----------|-----------|--------------|
| å†…å­˜å ç”¨ | ~50MB | ~200MB | ~30MB |
| Passkey æ”¯æŒ | âœ… åŸç”Ÿ | âœ… åŸç”Ÿ | âŒ ä¾èµ–å¤–éƒ¨ IdP |
| é…ç½®å¤æ‚åº¦ | ä¸­ | é«˜ | ä½ |
| ç”¨æˆ·ç®¡ç† | é…ç½®æ–‡ä»¶ | Web UI | å¤–éƒ¨ IdP |
| å¤šåº”ç”¨ SSO | æ”¯æŒ | æ”¯æŒ | æ”¯æŒ |

**å†³ç­–**ï¼šé€‰æ‹© Autheliaã€‚

**ç†ç”±**ï¼š
1. Passkey åŸç”Ÿæ”¯æŒï¼Œæ— éœ€å¤–éƒ¨ IdP
2. èµ„æºå ç”¨ä½ï¼Œé€‚åˆå•æœºéƒ¨ç½²
3. é…ç½®æ–‡ä»¶ç®¡ç†ç”¨æˆ·ï¼Œç¬¦åˆå•ç”¨æˆ·åœºæ™¯

**ä»£ä»·**ï¼š
1. æ·»åŠ ç”¨æˆ·éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶å¹¶é‡å¯å®¹å™¨
2. æ—  Web UI ç®¡ç†ç•Œé¢
3. **Passkey æ˜¯ 2FAï¼Œä¸æ˜¯ä¸€çº§è®¤è¯**ï¼ˆéœ€è¦å…ˆè¾“å…¥å¯†ç ï¼‰

### 3.3 åå‘ä»£ç†ï¼šä¸ºä»€ä¹ˆé€‰ Caddy è€Œé Nginx

| ç»´åº¦ | Caddy | Nginx |
|------|-------|-------|
| HTTPS è‡ªåŠ¨åŒ– | Let's Encrypt è‡ªåŠ¨ç”³è¯·/ç»­æœŸ | éœ€ certbot æ‰‹åŠ¨é…ç½® |
| é…ç½®æ–‡ä»¶ | æç®€ï¼ˆ3-5 è¡Œï¼‰ | å¤æ‚ï¼ˆ20+ è¡Œï¼‰ |
| æ€§èƒ½ | é«˜ | æé«˜ |
| ç¤¾åŒºèµ„æº | è¾ƒå°‘ | ä¸°å¯Œ |

**å†³ç­–**ï¼šé€‰æ‹© Caddyã€‚

**ç†ç”±**ï¼š
1. è‡ªåŠ¨ HTTPS æ˜¯æ ¸å¿ƒéœ€æ±‚ï¼ŒCaddy å¼€ç®±å³ç”¨
2. é…ç½®ç®€å•ï¼Œå‡å°‘è„šæœ¬å¤æ‚åº¦

**ä»£ä»·**ï¼š
1. é«˜çº§é…ç½®ï¼ˆå¦‚ Lua æ‰©å±•ï¼‰ä¸å¦‚ Nginx çµæ´»
2. ç¤¾åŒºæ–‡æ¡£å°‘äº Nginx

**å…³äº nip.io çš„è¯´æ˜**ï¼š

nip.io æ˜¯å…¬å…±åŸŸåæœåŠ¡ï¼Œæ‰€æœ‰ç”¨æˆ·å…±äº« Let's Encrypt çš„é€Ÿç‡é™åˆ¶ï¼ˆæ¯ä¸ªæ³¨å†ŒåŸŸåæ¯å‘¨ 50 å¼ è¯ä¹¦ï¼‰ã€‚
- **æ¨è**ï¼šä½¿ç”¨è‡ªæœ‰åŸŸå
- **å¤‡é€‰**ï¼šä½¿ç”¨ nip.ioï¼ˆå¯èƒ½å› é€Ÿç‡é™åˆ¶å¯¼è‡´è¯ä¹¦ç­¾å‘å¤±è´¥ï¼‰
- **å…œåº•**ï¼šCaddy è‡ªç­¾åè¯ä¹¦ï¼ˆæµè§ˆå™¨è­¦å‘Šä½†åŠ å¯†ï¼‰

### 3.4 è®¤è¯æ–¹å¼ï¼šä¸ºä»€ä¹ˆé€‰ä¸¤æ­¥è®¤è¯è€Œé Basic Auth

| ç»´åº¦ | ä¸¤æ­¥è®¤è¯ (å¯†ç  + Passkey) | Basic Auth | OAuth |
|------|--------------------------|------------|-------|
| æ‰‹æœºæ”¯æŒ | åŸç”Ÿï¼ˆé¢å®¹/æŒ‡çº¹ï¼‰ | éœ€è¾“å…¥å¯†ç  | éœ€è·³è½¬ |
| å®‰å…¨æ€§ | é«˜ï¼ˆå¯†ç  + ç¬¬äºŒå› ç´ ï¼‰ | ä½ï¼ˆä»…å¯†ç ï¼‰ | é«˜ |
| æŠ—é’“é±¼ | é«˜ï¼ˆåŸŸåç»‘å®šï¼‰ | æ—  | ä¸­ |
| é…ç½®å¤æ‚åº¦ | ä¸­ | ä½ | é«˜ |

**å†³ç­–**ï¼šé€‰æ‹©ä¸¤æ­¥è®¤è¯ã€‚

**ç†ç”±**ï¼š
1. æ¯” Basic Auth æ›´å®‰å…¨ï¼ˆéœ€è¦ä¸¤ä¸ªå› ç´ ï¼‰
2. Passkey ä½œä¸ºç¬¬äºŒå› ç´ ï¼Œæ‰‹æœºåŸç”Ÿæ”¯æŒ
3. é¢å®¹/æŒ‡çº¹éªŒè¯ä½“éªŒå¥½

**ä»£ä»·**ï¼š
1. éœ€è¦å…ˆè¾“å…¥å¯†ç ï¼Œå†è¿›è¡Œ Passkey éªŒè¯
2. é¦–æ¬¡ä½¿ç”¨éœ€è¦æ³¨å†Œ Passkey

**é‡è¦è¯´æ˜**ï¼šAuthelia çš„ Passkey æ˜¯ **2FAï¼ˆç¬¬äºŒå› ç´ ï¼‰**ï¼Œä¸æ˜¯ä¸€çº§è®¤è¯ã€‚
å®é™…æµç¨‹æ˜¯ï¼š
1. è¾“å…¥ç”¨æˆ·å
2. è¾“å…¥å¯†ç ï¼ˆ1FAï¼‰
3. ä½¿ç”¨ Passkey éªŒè¯ï¼ˆ2FAï¼‰
4. è¿›å…¥åº”ç”¨

---

## 4. æ¶æ„è®¾è®¡

### 4.1 æ ¸å¿ƒåˆ†å±‚

```
+----------------------------------------------------------------------+
|                           cloudcode æ¶æ„                             |
|                                                                      |
|  +----------------------------------------------------------------+  |
|  |  Access Layer (è®¿é—®å±‚)                                         |  |
|  |  +----------------------------------------------------------+  |  |
|  |  |  Caddy (Reverse Proxy + HTTPS)                           |  |  |
|  |  |  â€¢ è‡ªåŠ¨ HTTPS (Let's Encrypt)                             |  |  |
|  |  |  â€¢ åå‘ä»£ç†åˆ° Authelia                                    |  |  |
|  |  +----------------------------------------------------------+  |  |
|  +----------------------------------------------------------------+  |
|                                                                      |
|  +----------------------------------------------------------------+  |
|  |  Auth Layer (è®¤è¯å±‚)                                          |  |
|  |  +----------------------------------------------------------+  |  |
|  |  |  Authelia (Auth Gateway)                                  |  |  |
|  |  |  â€¢ 1FA: ç”¨æˆ·å + å¯†ç                                      |  |  |
|  |  |  â€¢ 2FA: Passkey/WebAuthn                                  |  |  |
|  |  |  â€¢ Session ç®¡ç†                                           |  |  |
|  |  +----------------------------------------------------------+  |  |
|  +----------------------------------------------------------------+  |
|                                                                      |
|  +----------------------------------------------------------------+  |
|  |  Application Layer (åº”ç”¨å±‚)                                   |  |
|  |  +----------------------------------------------------------+  |  |
|  |  |  OpenCode Container                                       |  |  |
|  |  |  â€¢ AI ç¼–ç¨‹åŠ©æ‰‹ Web UI                                     |  |  |
|  |  |  â€¢ ä»…ç›‘å¬ localhost:4096                                  |  |  |
|  |  +----------------------------------------------------------+  |  |
|  +----------------------------------------------------------------+  |
|                                                                      |
|  +----------------------------------------------------------------+  |
|  |  Storage Layer (å­˜å‚¨å±‚)                                       |  |
|  |  +----------------------------------------------------------+  |  |
|  |  |  Named Volumes (è¿è¡Œæ—¶æ•°æ®):                              |  |  |
|  |  |  â€¢ opencode-workspace: å·¥ä½œåŒºæ–‡ä»¶                         |  |  |
|  |  |  â€¢ opencode-config: OpenCode é…ç½®                         |  |  |
|  |  |  â€¢ caddy-data: SSL è¯ä¹¦                                    |  |  |
|  |  +----------------------------------------------------------+  |  |
|  |  +----------------------------------------------------------+  |  |
|  |  |  Bind Mounts (é…ç½®æ–‡ä»¶ï¼Œéƒ¨ç½²æ—¶é¢„å¡«å……):                     |  |  |
|  |  |  â€¢ ./authelia: Authelia é…ç½® + db.sqlite3                |  |  |
|  |  |  â€¢ ./Caddyfile: Caddy é…ç½®                                |  |  |
|  |  +----------------------------------------------------------+  |  |
|  +----------------------------------------------------------------+  |
+----------------------------------------------------------------------+
```

### 4.2 ç½‘ç»œæ¶æ„

```
+----------------------------------------------------------------------+
|                            ç½‘ç»œæµé‡å›¾                                 |
+----------------------------------------------------------------------+

    Internet
        |
        | HTTPS (443) / HTTP (80 for ACME)
        v
+---------------+
|     EIP       |  <--- å…¬ç½‘ IP (å¦‚ 47.123.45.67)
+---------------+
        |
        | DNAT to ECS private IP
        v
+---------------+
|  ECS Instance |
|  Ubuntu 24.04 |
|  +---------+  |
|  | Caddy   |  |  <--- ç«¯å£ 80 (HTTP-01 ACME) + 443 (HTTPS)
|  | :80,:443|  |
|  +----+----+  |
|       |       |
|       | reverse_proxy
|       v       |
|  +---------+  |
|  |Authelia |  |  <--- ç«¯å£ 9091 (å†…éƒ¨)
|  | :9091   |  |
|  +----+----+  |
|       |       |
|       | forward after auth
|       v       |
|  +---------+  |
|  |OpenCode |  |  <--- ç«¯å£ 4096 (localhost only)
|  | :4096   |  |
|  +---------+  |
+---------------+

å®‰å…¨ç»„å…¥ç«™è§„åˆ™:
+----------+----------+------------------+
| Protocol | Port     | Source           |
+----------+----------+------------------+
| TCP      | 22       | ç”¨æˆ· IP (å»ºè®®é™åˆ¶)|
| TCP      | 80       | 0.0.0.0/0        |
| TCP      | 443      | 0.0.0.0/0        |
+----------+----------+------------------+

æ³¨: 
- 80 ç«¯å£ç”¨äº Let's Encrypt HTTP-01 ACME challenge
- 4096 ç«¯å£ä¸å¯¹å¤–å¼€æ”¾ï¼Œä»… localhost è®¿é—®
```

### 4.3 å®‰å…¨æ¶æ„

```
+----------------------------------------------------------------------+
|                            å®‰å…¨å±‚æ¬¡å›¾                                 |
+----------------------------------------------------------------------+

Layer 4: Application Security
+------------------------------------------------------------------+
|  OpenCode å†…éƒ¨å®‰å…¨                                               |
|  â€¢ API Key ç¯å¢ƒå˜é‡æ³¨å…¥ï¼ˆä¸å†™å…¥é•œåƒï¼‰                             |
|  â€¢ Docker Volume éš”ç¦»å·¥ä½œåŒº                                       |
+------------------------------------------------------------------+

Layer 3: Authentication
+------------------------------------------------------------------+
|  Authelia è®¤è¯ç½‘å…³                                               |
|  â€¢ 1FA: ç”¨æˆ·å + å¯†ç                                             |
|  â€¢ 2FA: Passkey (WebAuthn/FIDO2)                                 |
|  â€¢ TOTP å¤‡ç”¨è®¤è¯                                                 |
|  â€¢ Session è¶…æ—¶è‡ªåŠ¨ç™»å‡º                                          |
+------------------------------------------------------------------+

Layer 2: Transport Security
+------------------------------------------------------------------+
|  Caddy HTTPS                                                     |
|  â€¢ TLS 1.3 å¼ºåˆ¶åŠ å¯†                                              |
|  â€¢ Let's Encrypt è‡ªåŠ¨è¯ä¹¦                                        |
|  â€¢ HSTS å¤´éƒ¨                                                     |
+------------------------------------------------------------------+

Layer 1: Network Security
+------------------------------------------------------------------+
|  é˜¿é‡Œäº‘å®‰å…¨ç»„                                                    |
|  â€¢ ä»…å¼€æ”¾ 22/80/443 ç«¯å£                                         |
|  â€¢ SSH å»ºè®®é™åˆ¶ç”¨æˆ· IP                                           |
|  â€¢ OpenCode æ— å…¬ç½‘ç«¯å£æš´éœ²                                       |
+------------------------------------------------------------------+
```

---

## 5. ç»„ä»¶è®¾è®¡

### 5.1 Deploy Scriptï¼ˆéƒ¨ç½²è„šæœ¬ï¼‰

#### 5.1.1 æ¨¡å—ç»“æ„

```
cloudcode/
â”œâ”€â”€ deploy.sh                  # ä¸»éƒ¨ç½²è„šæœ¬ï¼ˆå…¥å£ï¼‰
â”œâ”€â”€ destroy.sh                 # æ¸…ç†è„šæœ¬
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ alicloud.sh           # é˜¿é‡Œäº‘ API å°è£…
â”‚   â”œâ”€â”€ docker.sh             # Docker éƒ¨ç½²å°è£…
â”‚   â”œâ”€â”€ utils.sh              # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ config.sh             # é…ç½®ç®¡ç†
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ docker-compose.yml.j2 # Docker Compose æ¨¡æ¿
â”‚   â”œâ”€â”€ Caddyfile.j2          # Caddy é…ç½®æ¨¡æ¿
â”‚   â”œâ”€â”€ env.j2                # ç¯å¢ƒå˜é‡æ¨¡æ¿ (API Key ç­‰ï¼Œæ•æ„Ÿ)
â”‚   â”œâ”€â”€ authelia/
â”‚   â”‚   â”œâ”€â”€ config.yml.j2     # Authelia ä¸»é…ç½®
â”‚   â”‚   â””â”€â”€ users_database.yml.j2  # ç”¨æˆ·æ•°æ®åº“
â”‚   â””â”€â”€ Dockerfile.opencode   # OpenCode é•œåƒæ„å»º
â”œâ”€â”€ state/
â”‚   â””â”€â”€ state.json            # éƒ¨ç½²çŠ¶æ€æ–‡ä»¶ (åº”åŠ å…¥ .gitignore)
â””â”€â”€ .gitignore                # å¿½ç•¥æ•æ„Ÿæ–‡ä»¶ (state/, .env ç­‰)
```

#### 5.1.2 æ ¸å¿ƒå‡½æ•°

```bash
# lib/alicloud.sh
alicloud_auth()               # é˜¿é‡Œäº‘è®¤è¯æ£€æŸ¥
check_existing_resources()    # æ£€æµ‹å·²æœ‰èµ„æº
create_vpc()                  # åˆ›å»º VPC
create_vswitch()              # åˆ›å»ºäº¤æ¢æœº
create_security_group()       # åˆ›å»ºå®‰å…¨ç»„
create_ecs()                  # åˆ›å»º ECS å®ä¾‹
allocate_eip()                # åˆ†é… EIP
bind_eip()                    # ç»‘å®š EIP åˆ° ECS
destroy_all_resources()       # é‡Šæ”¾æ‰€æœ‰èµ„æº

# lib/docker.sh
install_docker()              # å®‰è£… Docker
deploy_compose()              # éƒ¨ç½² Docker Compose æ ˆ
configure_authelia()          # é…ç½® Authelia ç”¨æˆ·
render_env_file()             # æ¸²æŸ“ .env æ–‡ä»¶ (åŒ…å« API Key)

# lib/utils.sh
log_info()                    # ä¿¡æ¯æ—¥å¿—
log_error()                   # é”™è¯¯æ—¥å¿—
confirm()                     # äº¤äº’ç¡®è®¤
save_state()                  # ä¿å­˜éƒ¨ç½²çŠ¶æ€
load_state()                  # è¯»å–éƒ¨ç½²çŠ¶æ€
generate_session_secret()     # ç”Ÿæˆ Authelia session secret
generate_storage_encryption_key()  # ç”Ÿæˆ Authelia storage encryption key
hash_password()               # ç”Ÿæˆ Argon2id å¯†ç å“ˆå¸Œ
```

#### 5.1.3 çŠ¶æ€æ–‡ä»¶æ ¼å¼

```json
{
  "version": "1.0",
  "created_at": "2026-02-14T10:30:00Z",
  "region": "ap-southeast-1",
  "os_image": "ubuntu_24_04_x64",
  "resources": {
    "vpc": { "id": "vpc-xxx", "cidr": "192.168.0.0/16" },
    "vswitch": { "id": "vsw-xxx", "zone": "ap-southeast-1a" },
    "security_group": { "id": "sg-xxx" },
    "ecs": {
      "id": "i-xxx",
      "instance_type": "ecs.e-c1m2.large",
      "system_disk_size": 60,
      "public_ip": "47.x.x.x",
      "private_ip": "192.168.1.100"
    },
    "eip": { "id": "eip-xxx", "ip": "47.x.x.x" },
    "ssh_key_pair": { "name": "cloudcode-ssh-key", "private_key_path": "~/.ssh/cloudcode" }
  },
  "cloudcode": {
    "username": "admin",
    "domain": "opencode.example.com"
  }
}
```

**å®‰å…¨æé†’**ï¼š`state.json` åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œåº”åŠ å…¥ `.gitignore`ï¼Œä¸è¦æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ã€‚

#### 5.1.4 SSH å¯†é’¥ç®¡ç†

éƒ¨ç½²è„šæœ¬ä¼šè‡ªåŠ¨ç®¡ç† SSH å¯†é’¥ï¼š

1. **è‡ªåŠ¨åˆ›å»º**ï¼šè„šæœ¬åœ¨æœ¬åœ° `~/.ssh/` ç›®å½•åˆ›å»ºå¯†é’¥å¯¹ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
2. **ä¸Šä¼ å…¬é’¥**ï¼šåˆ›å»º ECS æ—¶å°†å…¬é’¥æ³¨å…¥åˆ°å®ä¾‹
3. **è®°å½•è·¯å¾„**ï¼šç§é’¥è·¯å¾„ä¿å­˜åœ¨ `state.json` ä¸­
4. **æƒé™è®¾ç½®**ï¼šç§é’¥æƒé™è®¾ä¸º 600

```
~/.ssh/cloudcode          # ç§é’¥ (chmod 600)
~/.ssh/cloudcode.pub      # å…¬é’¥
```

#### 5.1.5 å¹‚ç­‰æ€§ä¸å¤±è´¥å›æ»š

**å¹‚ç­‰æ€§ç­–ç•¥ï¼š**

`check_existing_resources()` ä¼šæ£€æµ‹ `state.json` ä¸­è®°å½•çš„èµ„æºæ˜¯å¦å·²å­˜åœ¨ï¼š

| åœºæ™¯ | è¡Œä¸º |
|------|------|
| `state.json` ä¸å­˜åœ¨ | é¦–æ¬¡éƒ¨ç½²ï¼Œä»é›¶åˆ›å»ºæ‰€æœ‰èµ„æº |
| `state.json` å­˜åœ¨ï¼Œèµ„æºå®Œæ•´ | æ£€æµ‹åˆ°å·²éƒ¨ç½²ï¼Œæç¤ºç”¨æˆ·ä½¿ç”¨ `--force` é‡æ–°éƒ¨ç½² |
| `state.json` å­˜åœ¨ï¼Œéƒ¨åˆ†èµ„æºç¼ºå¤± | ä¸­æ–­æ¢å¤æ¨¡å¼ï¼Œåªåˆ›å»ºç¼ºå¤±çš„èµ„æº |

**å¤±è´¥å›æ»šç­–ç•¥ï¼š**

éƒ¨ç½²è„šæœ¬é‡‡ç”¨"æ£€æµ‹-åˆ›å»º-è®°å½•"æ¨¡å¼ï¼Œæ¯åˆ›å»ºä¸€ä¸ªèµ„æºå°±æ›´æ–° `state.json`ï¼š

```
create_vpc()    â†’ è®°å½• vpc.id
create_vswitch() â†’ è®°å½• vswitch.id
create_security_group() â†’ è®°å½• sg.id
create_ecs()    â†’ è®°å½• ecs.id
...
```

å¦‚æœä¸­é€”å¤±è´¥ï¼š

1. æŸ¥çœ‹é”™è¯¯ä¿¡æ¯ï¼Œç¡®è®¤å¤±è´¥åŸå› 
2. ä¿®å¤é—®é¢˜åé‡æ–°æ‰§è¡Œ `./deploy.sh`ï¼Œè„šæœ¬ä¼šä»æ–­ç‚¹ç»§ç»­
3. å¦‚éœ€å®Œå…¨é‡ç½®ï¼Œå…ˆæ‰§è¡Œ `./destroy.sh` æ¸…ç†æ‰€æœ‰èµ„æº

**.env æ–‡ä»¶å®‰å…¨ï¼š**

`.env` æ–‡ä»¶åŒ…å« API Key ç­‰æ•æ„Ÿä¿¡æ¯ï¼š
- éƒ¨ç½²æ—¶ä»æ¨¡æ¿æ¸²æŸ“ï¼Œé€šè¿‡ scp ä¼ è¾“åˆ° ECS
- åº”åŠ å…¥ `.gitignore`ï¼Œä¸è¦æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
- ECS ä¸Šæ–‡ä»¶æƒé™è®¾ä¸º 600

### 5.2 Docker Composeï¼ˆå®¹å™¨ç¼–æ’ï¼‰

```yaml
services:
  caddy:
    image: caddy:2-alpine
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - authelia
      - opencode
    networks:
      - cloudcode-net

  authelia:
    image: authelia/authelia:4.38
    container_name: authelia
    restart: unless-stopped
    volumes:
      - ./authelia:/config
    environment:
      - TZ=Asia/Singapore
    expose:
      - 9091
    networks:
      - cloudcode-net

  opencode:
    build:
      context: .
      dockerfile: Dockerfile.opencode
    container_name: opencode
    restart: unless-stopped
    volumes:
      - opencode_workspace:/home/opencode/workspace
      - opencode_config:/home/opencode/.config/opencode
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    expose:
      - 4096
    networks:
      - cloudcode-net

volumes:
  caddy_data:
  caddy_config:
  opencode_workspace:
  opencode_config:

networks:
  cloudcode-net:
    driver: bridge
```

### 5.3 Caddyï¼ˆåå‘ä»£ç† + HTTPSï¼‰

```caddyfile
# Caddyfile.j2
{{ domain }} {
    # é‡å®šå‘ /auth åˆ° /auth/ (handle_path /auth/* ä¸åŒ¹é…æ— å°¾éƒ¨æ–œæ çš„æƒ…å†µ)
    redir /auth /auth/ 301

    # Authelia ç™»å½•é¡µé¢è·¯ç”± (handle_path è‡ªåŠ¨å‰¥ç¦» /auth å‰ç¼€)
    handle_path /auth/* {
        reverse_proxy authelia:9091
    }

    # ä¸»åº”ç”¨è·¯ç”±ï¼ˆéœ€è®¤è¯ï¼‰
    handle {
        # Authelia forward auth (Authelia 4.38+ ç«¯ç‚¹)
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }

        # è®¤è¯é€šè¿‡åè½¬å‘åˆ° OpenCode (Caddy è‡ªåŠ¨è®¾ç½® X-Forwarded-* å¤´éƒ¨)
        reverse_proxy opencode:4096
    }

    log {
        output stdout
        format console
    }
}
```

### 5.4 ç¯å¢ƒå˜é‡

```bash
# env.j2
OPENAI_API_KEY={{ openai_api_key }}
OPENAI_BASE_URL={{ openai_base_url }}
ANTHROPIC_API_KEY={{ anthropic_api_key }}
```

**å®‰å…¨æé†’**ï¼šæ­¤æ–‡ä»¶åŒ…å« API Keyï¼Œéƒ¨ç½²æ—¶æ¸²æŸ“å scp åˆ° ECSï¼Œä¸è¦æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ã€‚

### 5.5 Autheliaï¼ˆè®¤è¯ç½‘å…³ï¼‰

```yaml
# authelia/config.yml.j2 (Authelia 4.38+ æ ¼å¼)
server:
  address: 'tcp://0.0.0.0:9091/'

log:
  level: info

authentication_backend:
  file:
    path: /config/users_database.yml
    password:
      algorithm: argon2id
      iterations: 1
      salt_length: 16
      parallelism: 8
      memory: 64

session:
  name: authelia_session
  secret: {{ session_secret }}
  expiration: 12h
  inactivity: 30m
  cookies:
    - domain: {{ domain }}
      authelia_url: https://{{ domain }}/auth
      name: authelia_session
      same_site: lax

storage:
  encryption_key: {{ storage_encryption_key }}
  local:
    path: /config/db.sqlite3

webauthn:
  display_name: CloudCode
  attestation_conveyance_preference: indirect
  user_verification: preferred
  timeout:
    enable: true
    seconds: 60

totp:
  issuer: CloudCode
  period: 30
  skew: 1

access_control:
  default_policy: deny
  rules:
    # è±å… Authelia è‡ªèº«è·¯å¾„ï¼Œé¿å…æ­»å¾ªç¯
    - domain: {{ domain }}
      resources:
        - '^/auth([/?].*)?$'
      policy: bypass
    # ä¸»åº”ç”¨éœ€è¦ä¸¤æ­¥è®¤è¯
    - domain: {{ domain }}
      policy: two_factor

notifier:
  filesystem:
    filename: /config/notification.txt
```

```yaml
# authelia/users_database.yml.j2
users:
  {{ username }}:
    displayname: "{{ username }}"
    password: "{{ hashed_password }}"
    email: "{{ email }}"
    groups:
      - admins
```

### 5.6 OpenCodeï¼ˆAI ç¼–ç¨‹åŠ©æ‰‹ï¼‰

```dockerfile
# Dockerfile.opencode
FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive

# åŸºç¡€ä¾èµ–
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    git \
    openssh-client \
    sudo \
    nodejs \
    npm \
    python3 \
    python3-pip \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# å¯é€‰: Go å¼€å‘ç¯å¢ƒï¼ˆå¦‚éœ€åœ¨å®¹å™¨å†…ç¼–è¯‘ Go é¡¹ç›®ï¼Œå–æ¶ˆä¸‹æ–¹æ³¨é‡Šï¼‰
# RUN apt-get update && apt-get install -y --no-install-recommends golang-go && rm -rf /var/lib/apt/lists/*

RUN useradd -m -s /bin/bash opencode \
    && echo "opencode ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/opencode \
    && chmod 0440 /etc/sudoers.d/opencode

RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | \
    dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
    && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | \
    tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && apt-get update \
    && apt-get install -y gh \
    && rm -rf /var/lib/apt/lists/*

USER opencode
WORKDIR /home/opencode

# å®‰è£… OpenCode (å›ºå®šç‰ˆæœ¬å·ï¼Œé¿å…ä¸å¯æ§)
ARG OPENCODE_VERSION=latest
RUN if [ "$OPENCODE_VERSION" = "latest" ]; then \
        curl -fsSL https://opencode.ai/install | bash; \
    else \
        curl -fsSL -o /tmp/opencode "https://github.com/opencode-ai/opencode/releases/download/v${OPENCODE_VERSION}/opencode-linux-x64" \
        && chmod +x /tmp/opencode \
        && sudo mv /tmp/opencode /usr/local/bin/; \
    fi

RUN mkdir -p /home/opencode/.ssh \
    && touch /home/opencode/.ssh/known_hosts \
    && ssh-keyscan -T 5 github.com 2>/dev/null >> /home/opencode/.ssh/known_hosts || true

RUN mkdir -p /home/opencode/workspace

VOLUME ["/home/opencode/workspace"]
VOLUME ["/home/opencode/.config/opencode"]

EXPOSE 4096

ENTRYPOINT ["opencode", "web", "--hostname", "0.0.0.0", "--port", "4096"]
```

---

## 6. ç”¨æˆ·ä½“éªŒæµç¨‹

### 6.1 éƒ¨ç½²æµç¨‹

```
+----------+     check CLI     +-----------+     create VPC     +-----------+
|  Start   | ----------------> |  Config   | ----------------> |  Create   |
|          |                   |  Check    |                   |  VPC/VSwitch
+----------+                   +-----------+                   +-----------+
                                                                    |
                                                                    v
+-----------+     install Docker     +-----------+     deploy compose
|  Config   | <-------------------- |  SSH to   | <----------------+
|  Authelia |                       |  ECS      |
+-----------+                       +-----------+
      |
      | output access info
      v
+-----------+
|  Done     |
|  Output:  |
|  â€¢ URL    |
|  â€¢ User   |
+-----------+
```

**äº¤äº’æµç¨‹ç¤ºä¾‹ï¼š**

```bash
$ ./deploy.sh

ğŸš€ CloudCode é˜¿é‡Œäº‘ä¸€é”®éƒ¨ç½²å·¥å…·

[1/6] æ£€æŸ¥ä¾èµ–ç¯å¢ƒ...
âœ“ aliyun CLI å·²å®‰è£…
âœ“ jq å·²å®‰è£…
âœ“ ssh å·²å®‰è£…

[2/6] é…ç½®é˜¿é‡Œäº‘è®¤è¯:
æ£€æµ‹åˆ° ALICLOUD_ACCESS_KEY ç¯å¢ƒå˜é‡ï¼Œä½¿ç”¨ç°æœ‰é…ç½®
âœ“ é˜¿é‡Œäº‘è®¤è¯æˆåŠŸ

[3/6] é…ç½®è®¿é—®ä¿¡æ¯:
è¯·è¾“å…¥åŸŸå (æ¨èä½¿ç”¨è‡ªæœ‰åŸŸåï¼Œç•™ç©ºä½¿ç”¨ nip.io): 
âœ“ å°†ä½¿ç”¨ nip.io: <eip>.nip.io
  âš ï¸  æ³¨æ„: nip.io æ˜¯å…¬å…±æœåŠ¡ï¼Œå¯èƒ½å›  Let's Encrypt é€Ÿç‡é™åˆ¶å¯¼è‡´è¯ä¹¦ç­¾å‘å¤±è´¥
è¯·è¾“å…¥ç®¡ç†å‘˜ç”¨æˆ·å [admin]: 
è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç : ****
è¯·ç¡®è®¤ç®¡ç†å‘˜å¯†ç : ****

[4/6] é…ç½® OpenCode:
è¯·é€‰æ‹© AI æ¨¡å‹æä¾›å•†:
  1) OpenAI
  2) Anthropic
  3) è‡ªå®šä¹‰
é€‰æ‹© [1]: 1
è¯·è¾“å…¥ OpenAI API Key: sk-xxx
è¯·è¾“å…¥ Base URL [å›è½¦ä½¿ç”¨é»˜è®¤]: 

[5/6] åˆ›å»ºäº‘èµ„æº (é¢„è®¡ 5-10 åˆ†é’Ÿ):
âœ“ åˆ›å»º SSH å¯†é’¥å¯¹ (~/.ssh/cloudcode)
âœ“ åˆ›å»º VPC (vpc-xxx)
âœ“ åˆ›å»ºäº¤æ¢æœº (vsw-xxx)
âœ“ åˆ›å»ºå®‰å…¨ç»„ (sg-xxx) - å¼€æ”¾ 22/80/443
âœ“ åˆ›å»º ECS å®ä¾‹ (i-xxx) - Ubuntu 24.04, è§„æ ¼: ecs.e-c1m2.large
âœ“ åˆ†é… EIP (eip-xxx) - IP: 47.123.45.67
âœ“ ç»‘å®š EIP åˆ° ECS

[6/6] éƒ¨ç½²åº”ç”¨ (é¢„è®¡ 3-5 åˆ†é’Ÿ):
âœ“ SSH è¿æ¥ ECS æˆåŠŸ
âœ“ å®‰è£… Docker å’Œ Docker Compose
âœ“ åˆ›å»ºç›®å½•ç»“æ„
âœ“ éƒ¨ç½² Docker Compose æ ˆ
âœ“ ç­‰å¾…æœåŠ¡å¯åŠ¨...

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… éƒ¨ç½²å®Œæˆï¼

ğŸ“± è®¿é—®åœ°å€: https://47.123.45.67.nip.io
ğŸ‘¤ ç”¨æˆ·å: admin
ğŸ”‘ å¯†ç : <ä½ è®¾ç½®çš„å¯†ç >

âš ï¸ è®¤è¯æµç¨‹: ç”¨æˆ·å + å¯†ç  â†’ Passkey éªŒè¯
âš ï¸ é¦–æ¬¡ç™»å½•åå»ºè®®æ³¨å†Œ Passkey ä½œä¸ºç¬¬äºŒå› ç´ ï¼

ğŸ’¡ æç¤º:
   - SSH è®¿é—®: ssh -i ~/.ssh/cloudcode root@47.123.45.67
   - æ¸…ç†èµ„æº: ./destroy.sh
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

### 6.2 é¦–æ¬¡ç™»å½•ï¼ˆæ³¨å†Œ Passkeyï¼‰

```
Step 1: è®¿é—®æœåŠ¡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ç”¨æˆ·æ‰“å¼€ https://47.123.45.67.nip.io
        |
        v
+-------------------------------------------+
|  Authelia Login Page                       |
|  Username: [admin          ]              |
|  Password: [********        ]              |
|  [ Sign In ]                              |
+-------------------------------------------+

Step 2: è¾“å…¥å¯†ç ï¼ˆ1FAï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  è¾“å…¥ç”¨æˆ·å/å¯†ç ï¼Œç‚¹å‡» Sign In
        |
        v
+-------------------------------------------+
|  Two-Factor Authentication                 |
|  é€‰æ‹©ç¬¬äºŒå› ç´ éªŒè¯æ–¹å¼:                      |
|  [ ğŸ”‘ Passkey ]  [ ğŸ“± TOTP ]              |
+-------------------------------------------+

Step 3: Passkey éªŒè¯ï¼ˆ2FAï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ç‚¹å‡» Passkey
        |
        v
+-------------------------------------------+
|  é¦–æ¬¡ä½¿ç”¨: æ³¨å†Œ Passkey                    |
|  æµè§ˆå™¨ Passkey å¼¹çª—                        |
|  [ä½¿ç”¨é¢å®¹ ID] [ä½¿ç”¨ Touch ID] [ä½¿ç”¨å®‰å…¨å¯†é’¥]|
+-------------------------------------------+

Step 4: éªŒè¯æˆåŠŸ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  é¢å®¹/æŒ‡çº¹éªŒè¯æˆåŠŸ
        |
        v
+-------------------------------------------+
|  OpenCode Web UI                          |
|  âœ“ å·²ç™»å½•                                  |
|  âœ“ Passkey å·²æ³¨å†Œ                          |
|  âœ“ ä¸‹æ¬¡ç™»å½•: å¯†ç  â†’ Passkey                |
+-------------------------------------------+
```

### 6.3 æ—¥å¸¸ä½¿ç”¨

```
Step 1: è®¿é—®æœåŠ¡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ç”¨æˆ·æ‰“å¼€ https://47.123.45.67.nip.io
        |
        v
+-------------------------------------------+
|  Authelia Login Page                       |
|  Username: [admin          ]              |
|  Password: [********        ]              |
|  [ Sign In ]                              |
+-------------------------------------------+

Step 2: è¾“å…¥å¯†ç ï¼ˆ1FAï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  è¾“å…¥ç”¨æˆ·å/å¯†ç ï¼Œç‚¹å‡» Sign In
        |
        v
+-------------------------------------------+
|  Two-Factor Authentication                 |
|  æ£€æµ‹åˆ°å·²æ³¨å†Œ Passkey                       |
|  [ ğŸ”‘ Use Passkey ]                       |
+-------------------------------------------+

Step 3: Passkey éªŒè¯ï¼ˆ2FAï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ç‚¹å‡» Use Passkey
        |
        v
+-------------------------------------------+
|  æ‰‹æœºåŸç”ŸéªŒè¯                               |
|  (Face ID / Touch ID / æŒ‡çº¹)               |
+-------------------------------------------+

Step 4: è¿›å…¥åº”ç”¨
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  éªŒè¯æˆåŠŸï¼Œè‡ªåŠ¨è·³è½¬
        |
        v
+-------------------------------------------+
|  OpenCode Web UI                          |
|  âœ“ ä¸¤æ­¥éªŒè¯ç™»å½•æˆåŠŸ                        |
+-------------------------------------------+
```

---

## 7. æˆæœ¬ä¼°ç®—

### æŒ‰é‡ä»˜è´¹ï¼ˆæœˆåº¦ï¼‰

| èµ„æºé¡¹ | è§„æ ¼ | å•ä»· | æœˆè´¹ç”¨ (USD) | å¤‡æ³¨ |
|--------|------|------|-------------|------|
| ECS | ecs.e-c1m2.large (2C4G) | ~$0.02/h | ~$15 | æ–°åŠ å¡åœ°åŸŸï¼ŒUbuntu 24.04 |
| ç³»ç»Ÿç›˜ | ESSD 60GB | ~$0.05/GB | ~$3 | äº‘ç›˜è´¹ç”¨ |
| EIP | 1Mbps å¸¦å®½ | ~$0.003/h | ~$2 | æŒ‰å¸¦å®½è®¡è´¹ |
| æµé‡ | æŒ‰é‡ | $0.8/GB | ~$2 | é¢„ä¼° 2.5GB |
| **æ€»è®¡** | | | **~$22/æœˆ** | **çº¦ Â¥160/æœˆ** |

### æˆæœ¬ä¼˜åŒ–å»ºè®®

| ä¼˜åŒ–æ–¹å¼ | èŠ‚çœå¹…åº¦ | å®ç°æ–¹å¼ |
|----------|----------|----------|
| æŠ¢å å¼å®ä¾‹ | 70-90% | è®¾ç½®è‡ªåŠ¨ç«ä»·ï¼Œä½†å¯èƒ½è¢«å›æ”¶ |
| åœæ­¢ä¸ç”¨æ—¶ | æŒ‰å®é™…ä½¿ç”¨ | æ‰‹åŠ¨åœæ­¢ ECSï¼Œä»…ä¿ç•™ EIP è´¹ç”¨ |
| é™ä½å¸¦å®½ | 20-50% | æ”¹ç”¨æŒ‰æµé‡è®¡è´¹ï¼ˆé€‚åˆä½é¢‘è®¿é—®ï¼‰ |

### ä¸å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æœˆè´¹ç”¨ | HTTPS | ä¸¤æ­¥è®¤è¯ | è¿ç»´å¤æ‚åº¦ |
|------|--------|-------|---------|-----------|
| **cloudcode (æœ¬æ–¹æ¡ˆ)** | ~$22 | âœ… è‡ªåŠ¨ | âœ… | ä¸­ |
| SAE æ‰˜ç®¡ | ~$110 | âœ… è‡ªåŠ¨ | éœ€é¢å¤–é…ç½® | ä½ |
| åŸè®¾è®¡ï¼ˆæ— è®¤è¯ï¼‰ | ~$18 | âŒ æ—  | âŒ | ä¸­ |

---

## 8. å®ç°è§„åˆ’

### 8.1 ç›®å½•ç»“æ„

```
cloudcode/
â”œâ”€â”€ README.md                    # é¡¹ç›®è¯´æ˜
â”œâ”€â”€ .gitignore                   # å¿½ç•¥æ•æ„Ÿæ–‡ä»¶
â”œâ”€â”€ deploy.sh                    # ä¸»éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ destroy.sh                   # æ¸…ç†è„šæœ¬
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ alicloud.sh             # é˜¿é‡Œäº‘ API å°è£…
â”‚   â”œâ”€â”€ docker.sh               # Docker éƒ¨ç½²å°è£…
â”‚   â”œâ”€â”€ utils.sh                # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ config.sh               # é…ç½®ç®¡ç†
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ docker-compose.yml.j2   # Docker Compose æ¨¡æ¿
â”‚   â”œâ”€â”€ Caddyfile.j2            # Caddy é…ç½®æ¨¡æ¿
â”‚   â”œâ”€â”€ Dockerfile.opencode     # OpenCode é•œåƒæ„å»º
â”‚   â”œâ”€â”€ env.j2                  # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”‚   â””â”€â”€ authelia/
â”‚       â”œâ”€â”€ config.yml.j2       # Authelia ä¸»é…ç½®
â”‚       â””â”€â”€ users_database.yml.j2  # ç”¨æˆ·æ•°æ®åº“
â”œâ”€â”€ state/
â”‚   â””â”€â”€ .gitkeep                # çŠ¶æ€æ–‡ä»¶ç›®å½•
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ test_deploy.sh          # éƒ¨ç½²æµ‹è¯•è„šæœ¬
â””â”€â”€ docs/
    â””â”€â”€ design-oc.md            # æœ¬è®¾è®¡æ–‡æ¡£
```

### 8.2 å®ç°æ­¥éª¤

| æ­¥éª¤ | ä»»åŠ¡ | ä¾èµ– | éªŒè¯æ–¹å¼ |
|------|------|------|----------|
| 1 | å®ç°åŸºç¡€è„šæœ¬æ¡†æ¶ | æ—  | `./deploy.sh --help` æ­£å¸¸è¾“å‡º |
| 2 | å®ç°é˜¿é‡Œäº‘èµ„æºåˆ›å»º | æ­¥éª¤ 1 | èƒ½åˆ›å»º ECS å¹¶è·å– EIP |
| 3 | å®ç° SSH è¿œç¨‹éƒ¨ç½² | æ­¥éª¤ 2 | èƒ½è¿œç¨‹å®‰è£… Docker |
| 4 | ç¼–å†™ Docker Compose æ¨¡æ¿ | æ­¥éª¤ 3 | æœ¬åœ° `docker compose up` æˆåŠŸ |
| 5 | å®ç° Authelia é…ç½®ç”Ÿæˆ | æ­¥éª¤ 4 | ä¸¤æ­¥è®¤è¯æˆåŠŸ |
| 6 | å®ç°æ¸…ç†è„šæœ¬ | æ­¥éª¤ 2-5 | `./destroy.sh` èƒ½é‡Šæ”¾èµ„æº |
| 7 | ç«¯åˆ°ç«¯æµ‹è¯• | æ­¥éª¤ 1-6 | å®Œæ•´éƒ¨ç½²æµç¨‹é€šè¿‡ |
| 8 | ç¼–å†™æ–‡æ¡£ | æ­¥éª¤ 7 | README å®Œæ•´ |

### 8.3 æµ‹è¯•è¦ç‚¹

| æµ‹è¯•é¡¹ | æµ‹è¯•æ–¹æ³• | éªŒè¯æ ‡å‡† |
|--------|----------|----------|
| éƒ¨ç½²è„šæœ¬ | æ‰§è¡Œ `./deploy.sh` å®Œæ•´æµç¨‹ | æ‰€æœ‰èµ„æºåˆ›å»ºæˆåŠŸï¼ŒæœåŠ¡å¯è®¿é—® |
| HTTPS è®¿é—® | `curl -I https://<eip>.nip.io` | è¿”å› 302 é‡å®šå‘åˆ°ç™»å½•é¡µ |
| å¯†ç ç™»å½•ï¼ˆ1FAï¼‰ | æµè§ˆå™¨è¾“å…¥ç”¨æˆ·åå¯†ç  | è¿›å…¥ 2FA é¡µé¢ |
| Passkey éªŒè¯ï¼ˆ2FAï¼‰ | ä½¿ç”¨ Passkey éªŒè¯ | ç™»å½•æˆåŠŸè¿›å…¥ OpenCode |
| OpenCode åŠŸèƒ½ | åœ¨ Web UI ä¸­ä½¿ç”¨ AI å¯¹è¯ | æ­£å¸¸å“åº” |
| æ¸…ç†è„šæœ¬ | æ‰§è¡Œ `./destroy.sh` | æ‰€æœ‰èµ„æºé‡Šæ”¾ï¼Œè´¦å•åœæ­¢ |
| é‡å¤éƒ¨ç½² | å·²éƒ¨ç½²åå†æ¬¡æ‰§è¡Œ `./deploy.sh` | å¹‚ç­‰å¤„ç†ï¼Œä¸é‡å¤åˆ›å»ºèµ„æº |
| éƒ¨ç½²ä¸­æ–­æ¢å¤ | ä¸­é€” Ctrl+C åå†æ¬¡æ‰§è¡Œ | èƒ½æ£€æµ‹å·²æœ‰èµ„æºå¹¶ç»§ç»­ |
| Session è¿‡æœŸ | ç­‰å¾… 30 åˆ†é’Ÿä¸æ“ä½œ | è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ |
| å¯†ç é‡ç½® | æŸ¥çœ‹ notification.txt è·å–é‡ç½®é“¾æ¥ | èƒ½æˆåŠŸé‡ç½®å¯†ç  |

---

## 9. è¿ç»´ä¸å¤‡ä»½

### 9.1 æ•°æ®å¤‡ä»½ç­–ç•¥

Docker Volume å’Œå®¿ä¸»æœºç›®å½•ä¸­å­˜å‚¨äº†é‡è¦æ•°æ®ï¼Œå»ºè®®å®šæœŸå¤‡ä»½ï¼š

| æ•°æ® | å­˜å‚¨ä½ç½® | ç±»å‹ | å¤‡ä»½æ–¹å¼ | é¢‘ç‡ |
|------|----------|------|----------|------|
| å·¥ä½œåŒºæ–‡ä»¶ | opencode_workspace | Named Volume | ECS å¿«ç…§ / rsync | æ¯å‘¨ |
| OpenCode é…ç½® | opencode_config | Named Volume | ECS å¿«ç…§ | æ¯å‘¨ |
| Authelia é…ç½®åŠç”¨æˆ·æ•°æ® | ./authelia/ | Bind Mount | ECS å¿«ç…§ / tar | æ¯æœˆ |
| SSL è¯ä¹¦ | caddy_data | Named Volume | è‡ªåŠ¨ç»­æœŸ | æ— éœ€å¤‡ä»½ |

**å¤‡ä»½å‘½ä»¤ç¤ºä¾‹ï¼š**

```bash
# åœ¨ ECS ä¸Šæ‰§è¡Œ
docker run --rm \
  -v cloudcode_opencode_workspace:/data \
  -v $(pwd)/backup:/backup \
  alpine tar czf /backup/workspace-$(date +%Y%m%d).tar.gz /data

# æˆ–ä½¿ç”¨é˜¿é‡Œäº‘ ECS å¿«ç…§ (éœ€è¦å…ˆæŸ¥è¯¢ç£ç›˜ ID)
# aliyun ecs DescribeDisks --InstanceId i-xxx --query 'Disks.Disk[*].DiskId' --output text
aliyun ecs CreateSnapshot --DiskId d-xxx --SnapshotName "cloudcode-backup-$(date +%Y%m%d)"
```

### 9.2 å¸¸è§è¿ç»´ä»»åŠ¡

| ä»»åŠ¡ | å‘½ä»¤ |
|------|------|
| æŸ¥çœ‹æ—¥å¿— | `docker logs opencode` / `docker logs authelia` / `docker logs caddy` |
| é‡å¯æœåŠ¡ | `docker compose restart` |
| æ›´æ–° OpenCode | `docker compose build opencode && docker compose up -d opencode` |
| æŸ¥çœ‹ SSL è¯ä¹¦çŠ¶æ€ | `docker exec caddy caddy list-certs` |

**å¯†ç é‡ç½®æµç¨‹ï¼š**

Authelia ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿé€šçŸ¥å™¨ï¼Œå¯†ç é‡ç½®é“¾æ¥ä¼šå†™å…¥ `/config/notification.txt`ï¼š

```bash
# SSH åˆ° ECS åæŸ¥çœ‹é‡ç½®é“¾æ¥
cat ~/cloudcode/authelia/notification.txt

# è¾“å‡ºç¤ºä¾‹:
# Date: 2026-02-14 12:00:00
# Recipient: admin
# Link: https://your-domain/auth/reset-password/identity/verify?token=xxx

# è®¿é—®é“¾æ¥åå¯é‡ç½®å¯†ç 
```

**æ³¨æ„**ï¼šé‡ç½®å¯†ç åéœ€è¦é‡æ–°æ³¨å†Œ Passkeyï¼ˆå¦‚æœä¹‹å‰æ³¨å†Œè¿‡ï¼‰ã€‚

### 9.3 æ•…éšœæ¢å¤

| åœºæ™¯ | æ¢å¤æ–¹å¼ |
|------|----------|
| ECS å®ä¾‹æ•…éšœ | ä»å¿«ç…§æ¢å¤æˆ–é‡æ–°éƒ¨ç½² |
| æ•°æ®ä¸¢å¤± | ä»å¤‡ä»½æ¢å¤ Docker Volume |
| SSL è¯ä¹¦è¿‡æœŸ | Caddy è‡ªåŠ¨ç»­æœŸï¼Œå¦‚å¤±è´¥å¯é‡å¯å®¹å™¨ |

---

## å‚è€ƒæ–‡çŒ®

### æ ¸å¿ƒç»„ä»¶

- [OpenCode å®˜æ–¹æ–‡æ¡£](https://opencode.ai) â€” AI ç¼–ç¨‹åŠ©æ‰‹
- [Authelia å®˜æ–¹æ–‡æ¡£](https://www.authelia.com/) â€” ä¸¤æ­¥è®¤è¯ç½‘å…³
- [Caddy å®˜æ–¹æ–‡æ¡£](https://caddyserver.com/docs/) â€” è‡ªåŠ¨ HTTPS åå‘ä»£ç†
- [Docker Compose æ–‡æ¡£](https://docs.docker.com/compose/) â€” å®¹å™¨ç¼–æ’

### é˜¿é‡Œäº‘

- [é˜¿é‡Œäº‘ CLI æ–‡æ¡£](https://help.aliyun.com/zh/cli/) â€” å‘½ä»¤è¡Œå·¥å…·
- [ECS API å‚è€ƒ](https://help.aliyun.com/zh/ecs/developer-reference/api-ecs-2014-05-26-createinstance) â€” äº‘æœåŠ¡å™¨ API
- [EIP API å‚è€ƒ](https://help.aliyun.com/zh/vpc/developer-reference/api-eip-2016-04-28-allocateeipaddress) â€” å¼¹æ€§å…¬ç½‘ IP API

### å®‰å…¨å‚è€ƒ

- [WebAuthn è§„èŒƒ](https://www.w3.org/TR/webauthn/) â€” Passkey æŠ€æœ¯æ ‡å‡†
- [OWASP è®¤è¯å®‰å…¨æŒ‡å—](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html) â€” è®¤è¯æœ€ä½³å®è·µ
- [Let's Encrypt æ–‡æ¡£](https://letsencrypt.org/docs/) â€” å…è´¹ SSL è¯ä¹¦

### å‚è€ƒé¡¹ç›®

- [opencode-cloud](https://github.com/pRizz/opencode-cloud) â€” AWS/Railway éƒ¨ç½²å‚è€ƒ
- [Authelia ç¤ºä¾‹é…ç½®](https://github.com/authelia/authelia/tree/master/examples/compose) â€” Docker Compose ç¤ºä¾‹

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.8  
**æ›´æ–°æ—¥æœŸ**: 2026-02-14

**ä¿®è®¢è®°å½•**ï¼š
- v1.8: è¡¥å…… env.j2 æ¨¡æ¿å†…å®¹ï¼ˆæ–°å¢ 5.4 ç¯å¢ƒå˜é‡ç« èŠ‚ï¼‰ï¼›ä¿®æ­£æˆæœ¬ä¼°ç®—ï¼ˆå¢åŠ ç³»ç»Ÿç›˜è´¹ç”¨ $3ï¼Œæ€»è®¡ ~$22/æœˆï¼‰
- v1.7: è¡¥å…… env.j2 æ¨¡æ¿å’Œ render_env_file() å‡½æ•°ï¼›è¡¥å…… ECS ç³»ç»Ÿç›˜å¤§å°é…ç½® (60GB)ï¼›æ–°å¢ 5.1.5 å¹‚ç­‰æ€§ä¸å¤±è´¥å›æ»šç« èŠ‚ï¼›ç®€åŒ– Caddy reverse_proxy é…ç½®ï¼ˆç§»é™¤å†—ä½™ header_upï¼‰ï¼›è¡¥å……å¯†ç é‡ç½®æµç¨‹è¯´æ˜ï¼›è¡¥å……è¾¹ç•Œæµ‹è¯•åœºæ™¯
- v1.6: Authelia æ”¹ç”¨ bind mount (./authelia:/config)ï¼Œä¾¿äºéƒ¨ç½²æ—¶é¢„å¡«å……é…ç½®æ–‡ä»¶ï¼›æ˜ç¡®åŒºåˆ† Named Volumesï¼ˆè¿è¡Œæ—¶æ•°æ®ï¼‰å’Œ Bind Mountsï¼ˆé…ç½®æ–‡ä»¶ï¼‰ï¼›ä¿®æ­£æ€»ä½“è®¾è®¡å›¾å­˜å‚¨æè¿°
- v1.5: ä¿®æ­£ Docker Compose command ä¸ ENTRYPOINT å†²çªï¼›Authelia æ·»åŠ  storage.encryption_keyï¼›Caddyfile æ·»åŠ  /auth é‡å®šå‘ï¼›ç»Ÿä¸€ authelia å­˜å‚¨æè¿°ä¸º named volume (authelia_config)
- v1.4: Caddyfile /auth/* è·¯ç”±æ”¹ç”¨ handle_path è‡ªåŠ¨å‰¥ç¦»å‰ç¼€ï¼›ä¿®æ­£ ECS å¿«ç…§ API å‚æ•°ä¸º --DiskId
- v1.3: ä¿®æ­£ Authelia 4.38+ é…ç½®ï¼šserver.address æ ¼å¼ã€session.cookies.authelia_urlã€access_control bypass è‡ªèº«è·¯å¾„ï¼›Caddy æ—¥å¿—æ”¹ä¸º stdoutï¼›Dockerfile æ³¨é‡Šè¯´æ˜ golang-go å¯é€‰å®‰è£…
- v1.2: ä¿®æ­£ Caddyfile è¯­æ³•ï¼ˆåˆå¹¶ä¸ºå•ä¸€ site blockï¼Œä½¿ç”¨ handle åŒºåˆ†è·¯ç”±ï¼‰ï¼›æ›´æ–° Authelia forward auth ç«¯ç‚¹ä¸º 4.38+ æ ¼å¼ `/api/authz/forward-auth`
- v1.1: ä¿®æ­£ Authelia Passkey ä¸º 2FAï¼ˆéä¸€çº§è®¤è¯ï¼‰ï¼›è¡¥å…… 80 ç«¯å£ï¼›è¡¥å…… SSH å¯†é’¥ç®¡ç†ã€ECS é•œåƒã€å¤‡ä»½ç­–ç•¥ï¼›ç§»é™¤ Docker-in-Docker å†³ç­–ç†ç”±ï¼›æ›´æ–° Authelia é…ç½®æ ¼å¼ä¸º 4.38+ ç‰ˆæœ¬
