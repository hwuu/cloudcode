# Auth 子域名 - 直接代理 Authelia
auth.{{ .Domain }} {
    reverse_proxy authelia:9091
}

auth.{{ .Domain }}:8443 {
    reverse_proxy authelia:9091
}

# 主域名 - Web Terminal + OpenCode + forward_auth
{{ .Domain }} {
    # Web Terminal（需认证）
    # 使用 handle 而非 handle_path，保留 /terminal 前缀，
    # 因为 ttyd 配置了 --base-path /terminal，期望收到带前缀的请求
    handle /terminal/* {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy devbox:7681
    }

    # OpenCode Web UI（需认证）
    # opencode web 不支持 base-path，必须运行在根路径
    handle {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy devbox:4096
    }

    log {
        output stdout
        format console
    }
}

{{ .Domain }}:8443 {
    handle /terminal/* {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy devbox:7681
    }

    handle {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy devbox:4096
    }

    log {
        output stdout
        format console
    }
}
