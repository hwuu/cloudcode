# design.md v2.0 评审意见

**评审日期**: 2026-02-14
**评审版本**: v2.0

---

## 一、整体评价

文档从 Bash 重构为 Go，质量提升显著：

| 方面 | 评价 |
|------|------|
| **Go 选型** | 对比充分，理由有说服力 |
| **包结构** | 符合 Go 项目标准布局 |
| **CLI 设计** | cobra 是业界标准，命令简洁 |
| **幂等性策略** | 清晰说明了三种场景处理方式 |
| **go:embed** | 模板编译进二进制，分发简单 |

---

## 二、必须修正的问题

### 2.1 状态文件中 SSH 密钥路径使用 `~` 不规范

**位置**: design.md 第 534 行

**问题**: JSON 标准不支持 `~` 展开，应存储相对路径在运行时解析。

**当前代码**:
```json
"ssh_key_pair": { "name": "cloudcode-ssh-key", "private_key_path": "~/.cloudcode/ssh_key" }
```

**建议修改**:
```json
"ssh_key_pair": { "name": "cloudcode-ssh-key", "private_key_path": ".cloudcode/ssh_key" }
```

**Go 代码处理**:
```go
func ResolveKeyPath(relativePath string) (string, error) {
    home, err := os.UserHomeDir()
    if err != nil {
        return "", err
    }
    return filepath.Join(home, relativePath), nil
}
```

---

### 2.2 install.sh 写入 /usr/local/bin 缺少 sudo

**位置**: design.md 第 589-600 行

**问题**: `/usr/local/bin/` 需要 root 权限，普通用户执行会失败。

**当前代码**:
```bash
curl -fsSL "$RELEASE_URL" -o /usr/local/bin/cloudcode
chmod +x /usr/local/bin/cloudcode
```

**建议修改**:
```bash
#!/bin/bash
set -e

OS=$(uname -s | tr '[:upper:]' '[:lower:]')
ARCH=$(uname -m)
case "$ARCH" in
    x86_64) ARCH="amd64" ;;
    aarch64|arm64) ARCH="arm64" ;;
esac

RELEASE_URL="https://github.com/hwuu/cloudcode/releases/latest/download/cloudcode-${OS}-${ARCH}"

echo "Downloading cloudcode..."
curl -fsSL "$RELEASE_URL" | sudo tee /usr/local/bin/cloudcode > /dev/null
sudo chmod +x /usr/local/bin/cloudcode

echo "✅ cloudcode installed to /usr/local/bin/cloudcode"
echo "Run 'cloudcode --help' to get started"
```

---

### 2.3 goreleaser.yml 缺少 install.sh 配置

**位置**: design.md 第 606-623 行

**问题**: `install.sh` 不会被 goreleaser 自动包含在 release 中，需要手动配置。

**当前代码**:
```yaml
# .goreleaser.yml
builds:
  - main: ./cmd/cloudcode
    binary: cloudcode
    goos: [linux, darwin]
    goarch: [amd64, arm64]
```

**建议修改**:
```yaml
# .goreleaser.yml
before:
  hooks:
    - go mod tidy

builds:
  - main: ./cmd/cloudcode
    binary: cloudcode
    goos: [linux, darwin]
    goarch: [amd64, arm64]
    ldflags:
      - -s -w
      - -X main.version={{.Version}}
      - -X main.commit={{.Commit}}
      - -X main.date={{.Date}}

archives:
  - format: binary
    name_template: "{{ .Binary }}-{{ .Os }}-{{ .Arch }}"

release:
  extra_files:
    - glob: ./install.sh
      name_template: install.sh

checksum:
  name_template: checksums.txt
```

---

### 2.4 版本日期占位符

**位置**: design.md 第 1304 行

**问题**: 使用了占位符日期。

**当前**:
```text
**更新日期**: 2026-02-14
```

**建议**: 更新为实际日期或保留为模板变量。

---

## 三、建议改进

### 3.1 version 命令输出详情

**现状**: 设计文档第 509 行只说显示版本号。

**建议**: 输出更多调试信息。

**Go 实现**:
```go
// cmd/cloudcode/main.go
package main

import (
    "fmt"
    "runtime"
    
    "github.com/spf13/cobra"
)

var (
    version = "dev"
    commit  = "none"
    date    = "unknown"
)

func main() {
    rootCmd := &cobra.Command{
        Use:     "cloudcode",
        Short:   "One-click deploy OpenCode to Alibaba Cloud",
        Version: version,
        Run: func(cmd *cobra.Command, args []string) {
            cmd.Help()
        },
    }
    
    // 自定义 version 输出
    rootCmd.SetVersionTemplate(`cloudcode {{.Version}}
  commit: ` + commit + `
  built:  ` + date + `
  go:     ` + runtime.Version() + `
`)
    
    // 添加子命令
    rootCmd.AddCommand(deployCmd, statusCmd, destroyCmd)
    
    rootCmd.Execute()
}
```

**Makefile 构建**:
```makefile
VERSION := $(shell git describe --tags --always --dirty 2>/dev/null || echo "dev")
COMMIT  := $(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")
DATE    := $(shell date -u +"%Y-%m-%dT%H:%M:%SZ")

.PHONY: build
build:
	go build -ldflags "-s -w \
		-X main.version=$(VERSION) \
		-X main.commit=$(COMMIT) \
		-X main.date=$(DATE)" \
		-o bin/cloudcode ./cmd/cloudcode
```

**用户输出示例**:
```bash
$ cloudcode version
cloudcode v1.0.0
  commit: e7f4a81
  built:  2026-02-14T10:30:00Z
  go:     go1.21.5
```

---

### 3.2 日志输出控制

**现状**: 无日志级别控制。

**建议**: 添加 `-v` / `-q` 标志。

**Go 实现**:
```go
// internal/logger/logger.go
package logger

import (
    "fmt"
    "os"
)

type Level int

const (
    LevelQuiet Level = iota
    LevelInfo
    LevelDebug
)

var currentLevel = LevelInfo

func SetLevel(level Level) {
    currentLevel = level
}

func Debug(format string, args ...interface{}) {
    if currentLevel >= LevelDebug {
        fmt.Printf("  "+format+"\n", args...)
    }
}

func Info(format string, args ...interface{}) {
    if currentLevel >= LevelInfo {
        fmt.Printf(format+"\n", args...)
    }
}

func Error(format string, args ...interface{}) {
    fmt.Fprintf(os.Stderr, "❌ "+format+"\n", args...)
}

func Success(format string, args ...interface{}) {
    fmt.Printf("✅ "+format+"\n", args...)
}
```

**命令行参数**:
```go
// cmd/deploy.go
var verbose, quiet bool

deployCmd := &cobra.Command{
    Use:   "deploy",
    Short: "Deploy OpenCode to Alibaba Cloud",
    RunE: func(cmd *cobra.Command, args []string) error {
        if verbose && quiet {
            return fmt.Errorf("cannot use both --verbose and --quiet")
        }
        switch {
        case verbose:
            logger.SetLevel(logger.LevelDebug)
        case quiet:
            logger.SetLevel(logger.LevelQuiet)
        }
        return deploy.Run()
    },
}

deployCmd.Flags().BoolVarP(&verbose, "verbose", "v", false, "verbose output")
deployCmd.Flags().BoolVarP(&quiet, "quiet", "q", false, "suppress non-error output")
```

**用户体验**:
```bash
# 默认：关键步骤
$ cloudcode deploy
[1/6] 检查环境变量... ✓
[2/6] 配置访问信息...
✅ 部署完成！

# 详细模式：每个 API 调用
$ cloudcode deploy -v
[1/6] 检查环境变量...
  ALICLOUD_ACCESS_KEY_ID: AK...xxx
  SDK 连接测试... ✓
[2/6] 配置访问信息...
  创建 VPC 请求: {"RegionId":"ap-southeast-1"}
  VPC 创建成功: vpc-xxx
...

# 静默模式：仅结果
$ cloudcode deploy -q
https://47.123.45.67.nip.io
```

---

### 3.3 配置文件支持

**现状**: 仅交互式输入，CI/CD 不友好。

**建议**: 支持 `--config` 参数。

**配置文件格式** (`cloudcode.yaml`):
```yaml
# Alibaba Cloud 配置
alibaba_cloud:
  region: ap-southeast-1
  # AccessKey 从环境变量读取

# 域名配置
domain: opencode.example.com

# 认证配置
auth:
  username: admin
  password_hash: $argon2id$v=19$m=65536,t=1,p=8$...  # 或运行时输入
  # password_prompt: true

# OpenCode 配置
opencode:
  provider: openai  # openai | anthropic | custom
  openai_api_key: ${OPENAI_API_KEY}  # 支持环境变量
  openai_base_url: ""
```

**Go 配置加载**:
```go
// internal/config/config.go
package config

import (
    "os"
    "strings"
    
    "gopkg.in/yaml.v3"
)

type Config struct {
    AlibabaCloud struct {
        Region string `yaml:"region"`
    } `yaml:"alibaba_cloud"`
    
    Domain string `yaml:"domain"`
    
    Auth struct {
        Username       string `yaml:"username"`
        PasswordHash   string `yaml:"password_hash"`
        PasswordPrompt bool   `yaml:"password_prompt"`
    } `yaml:"auth"`
    
    OpenCode struct {
        Provider      string `yaml:"provider"`
        OpenAIAPIKey  string `yaml:"openai_api_key"`
        OpenAIBaseURL string `yaml:"openai_base_url"`
    } `yaml:"opencode"`
}

func LoadFromFile(path string) (*Config, error) {
    data, err := os.ReadFile(path)
    if err != nil {
        return nil, err
    }
    
    // 展开环境变量
    expanded := os.Expand(string(data), func(key string) string {
        return os.Getenv(key)
    })
    
    var cfg Config
    if err := yaml.Unmarshal([]byte(expanded), &cfg); err != nil {
        return nil, err
    }
    
    return &cfg, nil
}
```

**命令行支持**:
```go
var configFile string

deployCmd.Flags().StringVarP(&configFile, "config", "c", "", "config file path")

// 使用示例
// cloudcode deploy                     # 交互式
// cloudcode deploy --config cc.yaml    # 配置文件
```

**生成配置模板**:
```bash
$ cloudcode config init
✅ 配置模板已生成: ./cloudcode.yaml
请编辑后运行: cloudcode deploy --config cloudcode.yaml
```

---

### 3.4 destroy 命令确认提示

**现状**: 无确认步骤，误操作风险高。

**建议**: 添加确认提示和 `--force` 参数。

**Go 实现**:
```go
// internal/deploy/destroy.go
package deploy

import (
    "bufio"
    "fmt"
    "os"
    "strings"
    
    "cloudcode/internal/config"
)

func Destroy(cfg *config.Config, force, dryRun bool) error {
    state, err := config.LoadState()
    if err != nil {
        return fmt.Errorf("加载状态失败: %w", err)
    }
    
    // 显示将要删除的资源
    fmt.Println("⚠️  即将删除以下资源:")
    fmt.Printf("  • VPC: %s (%s)\n", state.Resources.VPC.ID, state.Resources.VPC.CIDR)
    fmt.Printf("  • VSwitch: %s\n", state.Resources.VSwitch.ID)
    fmt.Printf("  • SecurityGroup: %s\n", state.Resources.SecurityGroup.ID)
    fmt.Printf("  • ECS: %s (%s)\n", state.Resources.ECS.ID, state.Resources.ECS.PublicIP)
    fmt.Printf("  • EIP: %s (%s)\n", state.Resources.EIP.ID, state.Resources.EIP.IP)
    fmt.Println()
    
    if dryRun {
        fmt.Println("(dry-run) 上述资源将被删除，实际未执行")
        return nil
    }
    
    // 确认
    if !force {
        if !confirm("此操作不可逆！确认删除?") {
            fmt.Println("已取消")
            return nil
        }
    }
    
    // 执行删除
    return doDestroy(state)
}

func confirm(prompt string) bool {
    reader := bufio.NewReader(os.Stdin)
    fmt.Printf("%s [y/N]: ", prompt)
    input, _ := reader.ReadString('\n')
    return strings.TrimSpace(strings.ToLower(input)) == "y"
}
```

**命令行参数**:
```go
var force, dryRun bool

destroyCmd.Flags().BoolVar(&force, "force", false, "skip confirmation")
destroyCmd.Flags().BoolVar(&dryRun, "dry-run", false, "show what would be deleted")
```

**用户体验**:
```bash
$ cloudcode destroy

⚠️  即将删除以下资源:
  • VPC: vpc-xxx (192.168.0.0/16)
  • VSwitch: vsw-xxx
  • SecurityGroup: sg-xxx
  • ECS: i-xxx (47.123.45.67)
  • EIP: eip-xxx (47.123.45.67)

此操作不可逆！确认删除? [y/N]: y

正在删除...
  ✓ 释放 EIP (eip-xxx)
  ✓ 停止 ECS (i-xxx)
  ✓ 删除 ECS (i-xxx)
  ✓ 删除安全组
  ✓ 删除 VSwitch
  ✓ 删除 VPC
✅ 资源已全部释放
状态文件已删除: ~/.cloudcode/state.json
```

---

## 四、边界条件补充

### 4.1 前置检查

**建议在 design.md 5.1 节添加 5.1.7 前置检查章节**:

```
#### 5.1.7 前置检查

deploy 命令在创建资源前会执行以下检查：

| 检查项 | 检查方式 | 失败处理 |
|--------|----------|----------|
| 环境变量 | 检查 ALICLOUD_ACCESS_KEY_ID/SECRET 是否设置 | 提示设置方法 |
| SDK 连接 | 调用 STS.GetCallerIdentity | 提示检查网络或密钥权限 |
| 账户余额 | 调用 QueryAccountBalance | 余额 < ¥10 时警告 |
| 地域可用 | 调用 DescribeRegions | 提示选择其他地域 |
| 配额检查 | 检查 ECS/VPC 配额 | 提示申请提额 |

实现示例：

\`\`\`go
func preflightCheck() error {
    // 检查环境变量
    if os.Getenv("ALICLOUD_ACCESS_KEY_ID") == "" {
        return fmt.Errorf("请设置环境变量 ALICLOUD_ACCESS_KEY_ID")
    }
    
    // 检查 SDK 连接
    client, _ := openapi.NewClientWithAccessKey(
        "ap-southeast-1",
        os.Getenv("ALICLOUD_ACCESS_KEY_ID"),
        os.Getenv("ALICLOUD_ACCESS_KEY_SECRET"),
    )
    
    stsClient := sts.NewClient(client)
    resp, err := stsClient.GetCallerIdentity()
    if err != nil {
        return fmt.Errorf("SDK 连接失败: %w，请检查 AccessKey", err)
    }
    
    logger.Debug("账户 ID: %s", resp.Body.AccountId)
    return nil
}
\`\`\`
```

---

### 4.2 SSH 连接重试策略

**建议在 design.md 5.1.6 节补充**:

```
**SSH 连接策略：**

ECS 创建后需要等待才能 SSH 连接，采用指数退避重试：

\`\`\`go
func waitForSSH(host, user, keyPath string, timeout time.Duration) (*ssh.Client, error) {
    var lastErr error
    deadline := time.Now().Add(timeout)
    
    for time.Now().Before(deadline) {
        client, err := ssh.Dial("tcp", host+":22", &ssh.ClientConfig{
            User:            user,
            Auth:            []ssh.AuthMethod{publicKeyFile(keyPath)},
            HostKeyCallback: ssh.InsecureIgnoreHostKey(),
            Timeout:         10 * time.Second,
        })
        
        if err == nil {
            return client, nil
        }
        
        lastErr = err
        
        // 指数退避: 1s, 2s, 4s, 8s, 最多 10s
        wait := time.Duration(1<<uint(math.Min(float64(retryCount), 3))) * time.Second
        if wait > 10*time.Second {
            wait = 10 * time.Second
        }
        
        logger.Debug("SSH 连接失败，%v 后重试: %v", wait, err)
        time.Sleep(wait)
        retryCount++
    }
    
    return nil, fmt.Errorf("SSH 连接超时: %w", lastErr)
}
\`\`\`

**超时配置：**

| 阶段 | 超时时间 | 重试间隔 |
|------|----------|----------|
| ECS 状态变为 Running | 5 分钟 | 每 5 秒查询一次 |
| SSH 端口可连接 | 2 分钟 | 指数退避 (1s→10s) |
| SSH 认证成功 | 30 秒 | 3 次重试 |
| **总超时** | **10 分钟** | 失败后保留资源供排查 |
```

---

### 4.3 域名 DNS 配置说明

**建议在 design.md 6 节添加 6.6 域名 DNS 配置章节**:

```
### 6.6 域名 DNS 配置（自有域名）

如果使用自有域名，需要在 DNS 服务商配置解析。

**方式一：A 记录（推荐）**

| 记录类型 | 主机记录 | 记录值 |
|----------|----------|--------|
| A | opencode | 47.123.45.67 |

最终访问地址：`https://opencode.example.com`

**方式二：CNAME**

| 记录类型 | 主机记录 | 记录值 |
|----------|----------|--------|
| CNAME | opencode | 47.123.45.67.nip.io |

**阿里云 DNS 配置命令**：

\`\`\`bash
# 使用阿里云 CLI
aliyun alidns AddDomainRecord \\
  --DomainName example.com \\
  --RR opencode \\
  --Type A \\
  --Value 47.123.45.67
\`\`\`

**部署后提示**：

cloudcode deploy 完成后会输出：

\`\`\`
⚠️  如使用自有域名，请配置 DNS 解析：
  记录类型: A
  主机记录: opencode
  记录值:   47.123.45.67

  配置完成后访问: https://opencode.example.com
\`\`\`
```

---

## 五、总结

| 类型 | 数量 |
|------|------|
| 必须修正的问题 | 4 |
| 建议改进 | 4 |
| 边界条件补充 | 3 |

**文档整体质量很高**，Go 重构是正确决策。主要改进点：

1. ✅ 修正技术细节问题（第 2 节）
2. ✅ 完善用户体验（第 3 节）
3. ✅ 补充边界条件处理（第 4 节）

---

**评审人**: Claude (opencode)
**评审完成时间**: 2026-02-14
